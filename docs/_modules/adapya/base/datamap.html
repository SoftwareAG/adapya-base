

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>adapya.base.datamap &mdash; adapya-base 1.0.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/SAG2015.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> adapya-base
          

          
            
            <img src="../../../_static/SAG2015.ico" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide.html">Using adapya-base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Package Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indices.html">Indices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">adapya-base</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>adapya.base.datamap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for adapya.base.datamap</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: latin1 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">datamap - Map Memory Structures to Class Attributes</span>
<span class="sd">===================================================</span>

<span class="sd">The datamap.py module defines the Datamap class which allows to</span>
<span class="sd">map record or memory structures to class attributes</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>          <span class="c1"># PY3</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="k">import</span> <span class="n">hexlify</span><span class="p">,</span><span class="n">unhexlify</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span><span class="n">date</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">time</span> <span class="k">as</span> <span class="n">dtime</span>
<span class="kn">from</span> <span class="nn">.defs</span> <span class="k">import</span> <span class="n">Abuf</span>
<span class="kn">from</span> <span class="nn">.conv</span> <span class="k">import</span> <span class="n">ebc2asc</span><span class="p">,</span><span class="n">asc2ebc</span><span class="p">,</span><span class="n">str2asc</span><span class="p">,</span><span class="n">str2ebc</span><span class="p">,</span><span class="n">swap</span>
<span class="kn">from</span> <span class="nn">.dtconv</span> <span class="k">import</span> <span class="n">str2dt</span><span class="p">,</span><span class="n">date2natdate</span><span class="p">,</span> <span class="n">datetime2unixtime</span><span class="p">,</span> <span class="n">utc2xts</span>
<span class="kn">from</span> <span class="nn">.dtconv</span> <span class="k">import</span> <span class="n">timestamp2nattime</span><span class="p">,</span><span class="n">xts2utc</span><span class="p">,</span><span class="n">unix2utc</span>
<span class="kn">from</span> <span class="nn">.dtconv</span> <span class="k">import</span> <span class="n">natdate2date</span><span class="p">,</span> <span class="n">nattime2timestamp</span>
<span class="kn">from</span> <span class="nn">.dump</span> <span class="k">import</span> <span class="n">dump</span>
<span class="kn">from</span> <span class="nn">.stck</span> <span class="k">import</span> <span class="n">sstck</span><span class="p">,</span><span class="n">sstckd</span>

<span class="n">__date__</span><span class="o">=</span><span class="s1">&#39;$Date: 2019-11-08 15:01:35 +0100 (Fri, 08 Nov 2019) $&#39;</span>
<span class="n">__version__</span><span class="o">=</span><span class="s1">&#39;$Rev: 947 $&#39;</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
    <span class="n">PY3</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rawhex</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">PY3</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">rawhex</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


<span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># trace packing/unpacking into datamaps</span>
<span class="n">INDENT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># indent of debug information</span>

<span class="c1"># field formats</span>
<span class="c1"># const           C                Python</span>
<span class="n">T_STRING</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">T_BYTE</span>   <span class="o">=</span> <span class="mi">2</span>    <span class="c1"># string type binary</span>
<span class="n">T_UNPK</span>   <span class="o">=</span> <span class="mi">3</span>    <span class="c1"># ibm370 zoned     integer/long</span>
<span class="n">T_PACK</span>   <span class="o">=</span> <span class="mi">4</span>    <span class="c1"># ibm370 packed    integer/long</span>
<span class="n">T_DMAP</span>   <span class="o">=</span> <span class="mi">5</span>    <span class="c1"># substructure defined by Datamap</span>
<span class="n">T_UTF16</span>  <span class="o">=</span> <span class="s1">&#39;u&#39;</span>  <span class="c1"># uint2 unicode swapping platform dependent</span>
<span class="n">T_UTF8</span>   <span class="o">=</span> <span class="s1">&#39;t&#39;</span>  <span class="c1"># utf-8 unicode</span>
<span class="c1"># --- struct format characters ---</span>
<span class="n">T_CHAR</span>   <span class="o">=</span> <span class="s1">&#39;c&#39;</span>  <span class="c1"># char             string len=1</span>
<span class="n">T_INT1</span>   <span class="o">=</span> <span class="s1">&#39;b&#39;</span>  <span class="c1"># signed char      integer</span>
<span class="n">T_UINT1</span>  <span class="o">=</span> <span class="s1">&#39;B&#39;</span>  <span class="c1"># unsigned char    integer</span>
<span class="n">T_INT2</span>   <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<span class="n">T_UINT2</span>  <span class="o">=</span> <span class="s1">&#39;H&#39;</span>
<span class="n">T_INT4</span>   <span class="o">=</span> <span class="s1">&#39;l&#39;</span>
<span class="n">T_UINT4</span>  <span class="o">=</span> <span class="s1">&#39;L&#39;</span>
<span class="n">T_PTR</span>    <span class="o">=</span> <span class="s1">&#39;P&#39;</span>  <span class="c1"># void *</span>
<span class="n">T_INT8</span>   <span class="o">=</span> <span class="s1">&#39;q&#39;</span>
<span class="n">T_UINT8</span>  <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
<span class="n">T_FLOAT</span>  <span class="o">=</span> <span class="s1">&#39;f&#39;</span>  <span class="c1"># 4 byte IEEE float</span>
<span class="n">T_DOUBLE</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>  <span class="c1"># 8 byte IEEE double</span>

<span class="c1"># dict mapping datamap types to Adabas format</span>
<span class="c1"># Note: some types are not (yet) supported T_MAP</span>
<span class="n">DM2ADAF</span> <span class="o">=</span> <span class="p">{</span><span class="n">T_STRING</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">T_BYTE</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">T_UNPK</span><span class="p">:</span><span class="s1">&#39;U&#39;</span><span class="p">,</span>
           <span class="n">T_PACK</span><span class="p">:</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="c1"># T_DMAP</span>
           <span class="n">T_CHAR</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">T_INT1</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">T_UINT1</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span>
           <span class="n">T_INT2</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">T_UINT2</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">T_INT4</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">,</span>
           <span class="n">T_UINT4</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="c1"># T_PTR</span>
           <span class="n">T_INT8</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">T_UINT8</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">T_FLOAT</span><span class="p">:</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="n">T_DOUBLE</span><span class="p">:</span><span class="s1">&#39;G&#39;</span><span class="p">,</span>
           <span class="n">T_UTF16</span><span class="p">:</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">}</span>

<span class="c1"># dict mapping datamap types to Adabas format</span>
<span class="c1"># Predict knows also &#39;I&#39;, &#39;LA&#39;, &#39;LO&#39;, &#39;D&#39;, &#39;T&#39;</span>
<span class="c1"># Note: some types are not (yet) supported T_MAP</span>
<span class="n">PRD2DM</span> <span class="o">=</span> <span class="p">{</span>  <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">T_STRING</span><span class="p">,</span>
            <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">T_BYTE</span><span class="p">,</span>
            <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">T_FLOAT</span><span class="p">,</span>
            <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">T_INT1</span><span class="p">,</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">T_UNPK</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">T_PACK</span><span class="p">,</span>
            <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">T_UTF16</span><span class="p">,</span> <span class="c1">#??</span>
            <span class="c1"># &#39;LA&#39;: T_STRING, # long alpha   / also binary?</span>
            <span class="c1"># &#39;LO&#39;: T_STRING, # long LOB    / also binary?</span>
            <span class="p">}</span>

<div class="viewcode-block" id="prd2dm"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.prd2dm">[docs]</a><span class="k">def</span> <span class="nf">prd2dm</span><span class="p">(</span><span class="n">prdformat</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get Datamap field code from Predict format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">PRD2DM</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prdformat</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">T_INT1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T_INT2</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T_INT4</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">T_INT8</span>
    <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="n">T_FLOAT</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">T_DOUBLE</span>
    <span class="k">return</span> <span class="n">f</span></div>


<span class="n">LEFT_ALIGNED</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_STRING</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">)</span>

<span class="c1"># additional field options (opt)</span>
<span class="n">T_IN</span>   <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># write access</span>
<span class="n">T_OUT</span>  <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># read access</span>
<span class="n">T_INOUT</span><span class="o">=</span> <span class="mi">3</span>  <span class="c1"># read/write</span>
<span class="n">T_STCK</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># convert store clock - use with Uint4 or Uint8</span>
<span class="n">T_HEX</span>  <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># display hex (limited to 8 bytes)</span>
<span class="n">T_NONE</span> <span class="o">=</span> <span class="mi">16</span> <span class="c1"># dummy/filler field, do not display in dprint()</span>
<span class="n">T_EBCDIC</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># data is EBCDIC</span>
<span class="n">T_VAR0</span> <span class="o">=</span> <span class="mi">64</span>   <span class="c1"># Variable</span>
<span class="n">T_VAR1</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># Variable 1 byte  incl.</span>
<span class="n">T_VAR2</span> <span class="o">=</span> <span class="mi">256</span>  <span class="c1"># Variable 2 bytes incl.</span>
<span class="n">T_VAR4</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># Variable 4 bytes incl.</span>
<span class="n">T_DT</span> <span class="o">=</span> <span class="mi">1024</span>   <span class="c1"># convert to/from datetime() object</span>
<span class="n">T_NWBO</span> <span class="o">=</span> <span class="mi">2048</span> <span class="c1"># Net-work byte order alias big-endian</span>
<span class="n">T_GMT</span> <span class="o">=</span> <span class="mi">4096</span>  <span class="c1"># use in conjunction with T_STCK if value is in GMT</span>
              <span class="c1"># and not local time</span>
<span class="n">T_MUPE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">13</span> <span class="c1"># MUPE indicator in getpossiz(), not used in field defn</span>

<span class="n">NATIVEBO</span><span class="o">=</span><span class="s1">&#39;=&#39;</span>  <span class="c1"># struct format character: native, standard size, no alignment</span>
<span class="n">NETWORKBO</span><span class="o">=</span><span class="s1">&#39;!&#39;</span> <span class="c1"># struct format character: big-endian, standard size, no alignment</span>
<span class="n">NATIVEBO_ALIGNED</span><span class="o">=</span><span class="s1">&#39;@&#39;</span> <span class="c1"># struct format character: big-endian, standard size, natvie alignment</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span><span class="s1">&#39;little&#39;</span><span class="p">:</span>
    <span class="n">UTF16_NATIVE</span> <span class="o">=</span> <span class="s1">&#39;utf_16_le&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">UTF16_NATIVE</span> <span class="o">=</span> <span class="s1">&#39;utf_16_be&#39;</span>



<div class="viewcode-block" id="field"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.field">[docs]</a><span class="k">def</span> <span class="nf">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a field element.</span>

<span class="sd">    A field element is used in the list of fields in a datamap class.</span>
<span class="sd">    It defines mainly name, format and size.</span>

<span class="sd">    Valid keywords for options i.e. keyword = value list:</span>

<span class="sd">    :param opt: define extra formatting e.g. (T_STCK, T_HEX) - see also below</span>
<span class="sd">        on variable length strings</span>

<span class="sd">        To define fields in other data architecture:</span>

<span class="sd">        - **T_EBCDIC**  field data is in EBCDIC (String, Packed, Unpacked, Char)</span>
<span class="sd">        - **T_NWBO**    field data is big-endian or high-order-byte-first</span>
<span class="sd">          rather than native byte-order</span>

<span class="sd">        To define this for all fields in a datamap use the setting on the</span>
<span class="sd">        datamap level:</span>

<span class="sd">            Datamap(..., ebcdic=1, byteorder=NETWORKBO)</span>

<span class="sd">        To define variable length strings:</span>

<span class="sd">            opt in (T_VAR0, T_VAR1, T_VAR2, T_VAR4)</span>

<span class="sd">        for AAL length reference, 1, 2, 4 byte length prefix</span>

<span class="sd">        To cumulate options join them with bitwise-or &#39;|&#39;</span>

<span class="sd">    :param fn: define Adabas field name. This is used in genfb() and</span>
<span class="sd">        getfndef() functions to generate the format buffer related</span>
<span class="sd">        to the datamap.</span>

<span class="sd">    :param pos: define **new offset** from start of datamap</span>

<span class="sd">    :param repos: reposition **relative** from current position</span>

<span class="sd">    :param caption: field text for dprint() or lprint()</span>

<span class="sd">    :param ppfunc: formatting function for dprint()</span>

<span class="sd">    :param colsize: column size for lprint()</span>

<span class="sd">    :param dt: &#39;DATETIME&#39; (= Adabas datetime editmask) is used to map</span>
<span class="sd">        to/from Python datetime object (currently only DATETIME)</span>

<span class="sd">    :param sizefunc: reference to size function if T_VAR0 (AAL)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="Periodic"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Periodic">[docs]</a><span class="k">def</span> <span class="nf">Periodic</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="n">occurs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Define periodic group with a datamap dmap on the fields of the group</span>
<span class="sd">    keywords for options:</span>

<span class="sd">    :param occurs: number of repetitions of group, parameter may be a function.</span>

<span class="sd">        If function returns -1 or -2: byte position(s) before</span>
<span class="sd">        the field contain the actual count. For example::</span>

<span class="sd">            occurs=lambda:-2</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dmap</span><span class="o">.</span><span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
        <span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span>                 <span class="c1"># length of periodic group dynamic</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plen</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="n">dmlen</span><span class="o">*</span><span class="n">occurs</span> <span class="c1"># length of periodic group fixed</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Periodic definition&#39;</span><span class="p">,</span> <span class="n">dmap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="s1">&#39;T_DMAP&#39;</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">submap</span><span class="o">=</span><span class="n">dmap</span><span class="p">,</span><span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">T_DMAP</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">submap</span><span class="o">=</span><span class="n">dmap</span><span class="p">,</span><span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">))</span></div>
    <span class="c1"># Multiple() instance will be created during init of enclosing Datamap</span>
    <span class="c1"># i.e. Multiple(self,dmap.dmname,occurs=occurs,submap=dmap)</span>

<span class="k">def</span> <span class="nf">String</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T_STRING</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="Unicode"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Unicode">[docs]</a><span class="k">def</span> <span class="nf">Unicode</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;size in unicode characters * 2 = size in bytes &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">Utf8</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Packed</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_PACK</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Unpacked</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_UNPK</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<div class="viewcode-block" id="Bytes"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Bytes">[docs]</a><span class="k">def</span> <span class="nf">Bytes</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="s2">&quot;Byte string (binary)&quot;</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T_BYTE</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="Filler"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Filler">[docs]</a><span class="k">def</span> <span class="nf">Filler</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="s2">&quot;Byte filler&quot;</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T_BYTE</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">T_NONE</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">Char</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_CHAR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Int1</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_INT1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Uint1</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_UINT1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Int2</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_INT2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Uint2</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_UINT2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Int4</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_INT4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Uint4</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_UINT4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Int8</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_INT8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Uint8</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_UINT8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Float</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_FLOAT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Double</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_DOUBLE</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Pointer</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">field</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">T_PTR</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>



<div class="viewcode-block" id="DatamapError"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.DatamapError">[docs]</a><span class="k">class</span> <span class="nc">DatamapError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error Class for Datamap Exceptions</span>

<span class="sd">    :attr string: Adabas response string</span>
<span class="sd">    :attr dmap: Datamap instance where the error occurred</span>

<span class="sd">    Usage example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       try:</span>
<span class="sd">           raise DatamapError(&#39;error text&#39;, dmap)</span>
<span class="sd">       except DatamapError as e:</span>
<span class="sd">           print( &#39;DatamapError&#39;, e.value, e.__class__)</span>
<span class="sd">           dump(e.dmap)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dmap</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">dmap</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<span class="n">sbuf</span><span class="o">=</span><span class="n">Abuf</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="c1"># get work buffer</span>

<span class="n">U0</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">29</span>             <span class="c1"># nulls</span>
<span class="n">P0</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">14</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x0c</span><span class="s1">&#39;</span>  <span class="c1"># nulls e.g. for length = 3  P0[-3:]</span>

<span class="c1"># global for all datamap instances</span>
<span class="c1"># overrides any instance settings if 1 (=True)</span>
<span class="n">dataIsEbcdic</span><span class="o">=</span><span class="mi">0</span>
<span class="n">byteOrder</span><span class="o">=</span><span class="n">NATIVEBO</span>

<div class="viewcode-block" id="setEbcdic"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.setEbcdic">[docs]</a><span class="k">def</span> <span class="nf">setEbcdic</span><span class="p">(</span><span class="n">yesno</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;set EBCDIC data in map</span>
<span class="sd">    :param yesno: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">dataIsEbcdic</span>
    <span class="n">dataIsEbcdic</span> <span class="o">=</span> <span class="n">yesno</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;setEbcdic()&#39;</span> <span class="p">,</span> <span class="n">yesno</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">setNativeByteOrder</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">byteOrder</span>
    <span class="n">byteOrder</span> <span class="o">=</span> <span class="n">NATIVEBO</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;setNativeByteOrder()&#39;</span> <span class="p">,</span> <span class="n">byteOrder</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setNetworkByteOrder</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">byteOrder</span>
    <span class="n">byteOrder</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;setNetworkByteOrder()&#39;</span><span class="p">,</span> <span class="n">byteOrder</span><span class="p">)</span>


<div class="viewcode-block" id="bit_str"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.bit_str">[docs]</a><span class="k">def</span> <span class="nf">bit_str</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">istrList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce readable print of integer or single byte input</span>

<span class="sd">    :param b: byte or integer</span>
<span class="sd">    :param istrList: list of tuples containing the bits</span>
<span class="sd">        and the corresponding string.</span>

<span class="sd">        Optionally a third element of a tuple may be a</span>
<span class="sd">        string that is taken as default when the bits are</span>
<span class="sd">        all not set.</span>

<span class="sd">    Examples::</span>

<span class="sd">      &gt;&gt;&gt; from adapya.base.datamap import bit_str</span>
<span class="sd">      &gt;&gt;&gt; print( bit_str(b&#39;\\x03&#39;,[(1,&#39;one&#39;),(2,&#39;two&#39;)]))</span>
<span class="sd">      one,two</span>

<span class="sd">      &gt;&gt;&gt; print( bit_str(b&#39;\\x03&#39;,[(3,&#39;three&#39;),(1,&#39;one&#39;),(2,&#39;two&#39;)]))</span>
<span class="sd">      three</span>

<span class="sd">      &gt;&gt;&gt; print( bit_str(b&#39;\\x06&#39;,[(3,&#39;three&#39;),(1,&#39;one&#39;),(2,&#39;two&#39;)]))</span>
<span class="sd">      two,X&#39;04&#39;</span>

<span class="sd">      &gt;&gt;&gt; bit_str(b&#39;\\x86&#39;,[(2,&#39;two&#39;),(0x80,&#39;negative&#39;,&#39;positive&#39;)])</span>
<span class="sd">      &quot;two,negative,X&#39;04&#39;&quot;</span>

<span class="sd">      &gt;&gt;&gt; bit_str(b&#39;\\x00&#39;,[(2,&#39;two&#39;),(0x80,&#39;negative&#39;,&#39;positive&#39;)])</span>
<span class="sd">      &#39;positive&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">b</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># string or b&#39;&#39; type</span>
        <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;=B&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">istrList</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">istrList</span><span class="o">=</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">istrList</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>      <span class="c1"># check if string given if i bits not set</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">defs</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">item</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">&amp;</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="n">i</span><span class="p">:</span>            <span class="c1"># all i bits set in x</span>
            <span class="n">x</span><span class="o">^=</span><span class="n">i</span>                <span class="c1"># reset used bits</span>
            <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x</span><span class="o">&amp;</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">defs</span><span class="p">:</span> <span class="c1"># no bit is set and a default string is given</span>
            <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">defs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;X&#39;</span><span class="si">%02X</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="c1"># add hex values w/o symbols</span>

    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>          <span class="c1"># return &#39;&#39; or symbols separated by &#39;+&#39;</span></div>


<div class="viewcode-block" id="flag_str"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.flag_str">[docs]</a><span class="k">def</span> <span class="nf">flag_str</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span><span class="n">flist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is similar to bit_str but only lists the elements</span>
<span class="sd">    for which a definition exists.</span>

<span class="sd">    :param flag: integer</span>
<span class="sd">    :param flist: list of (integer, string) tuples</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; flag_str(3, ((1,&#39;one&#39;),(2,&#39;two&#39;),(4,&#39;four&#39;)))</span>
<span class="sd">        &#39;one,two&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ss</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span></div>

<div class="viewcode-block" id="flag_strc"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.flag_strc">[docs]</a><span class="k">def</span> <span class="nf">flag_strc</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span><span class="n">flist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Similar to flag_str but compressed i.e. without commas</span>
<span class="sd">    each flag bit is represented by a string or a &#39;.&#39;</span>

<span class="sd">    :param flag: integer</span>
<span class="sd">    :param flist: list of (integer, string) tuples</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; flag_strc(5, ((1,&#39;O&#39;),(2,&#39;T&#39;),(4,&#39;F&#39;)))</span>
<span class="sd">        &#39;O.F&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ss</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span></div>

<div class="viewcode-block" id="str_str"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.str_str">[docs]</a><span class="k">def</span> <span class="nf">str_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">strdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a readable string from the value</span>
<span class="sd">    if it exists otherwise the hex value for integers or blank</span>

<span class="sd">    :param s: value (could be string or int: key for dict)</span>
<span class="sd">    :param strdict: dict containing the interpretation</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; str_str(&#39;quark&#39;, {&#39;quark&#39;:&#39;one&#39;,2:&#39;two&#39;,4:&#39;four&#39;})</span>
<span class="sd">        &#39;one&#39;</span>
<span class="sd">        &gt;&gt;&gt; str_str(3, {1:&#39;one&#39;,2:&#39;two&#39;,4:&#39;four&#39;})</span>
<span class="sd">        &quot;X&#39;03&#39;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strdict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">strdict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># integer</span>
            <span class="k">return</span>  <span class="s2">&quot;X&#39;</span><span class="si">%02X</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="list_str"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.list_str">[docs]</a><span class="k">def</span> <span class="nf">list_str</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">istrList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Produce readable print from list</span>

<span class="sd">    :param i:  position in list</span>
<span class="sd">    :param istrList: List of strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mi">0</span><span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">istrList</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">istrList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<span class="k">def</span> <span class="nf">dpack</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">dataIsEbcdic</span>
    <span class="k">global</span> <span class="n">byteOrder</span>

    <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span>  <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">indx</span><span class="o">*</span><span class="n">size</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">size</span>
    <span class="n">ebcdic</span> <span class="o">=</span>  <span class="n">inout</span><span class="o">&amp;</span><span class="n">T_EBCDIC</span> <span class="ow">or</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dataIsEbcdic</span>

    <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span> <span class="k">if</span> <span class="p">(</span><span class="n">inout</span><span class="o">&amp;</span><span class="n">T_NWBO</span><span class="p">)</span> <span class="k">else</span> \
           <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder is None take global</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.dpack(</span><span class="si">%s</span><span class="s1">,indx=</span><span class="si">%r</span><span class="s1">) size=</span><span class="si">%d</span><span class="s1"> start=</span><span class="si">%d</span><span class="s1"> stop=</span><span class="si">%d</span><span class="s1">, inout=</span><span class="si">%d</span><span class="s1">, fdic=</span><span class="si">%r</span><span class="s1">, bo=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span><span class="p">,</span> <span class="n">bo</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_IN</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> must not be modified&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="n">dmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_STRING</span><span class="p">:</span>
        <span class="n">fieldlen</span> <span class="o">=</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span>
        <span class="c1"># print( &#39;datamap setattr: key=%s, data=%s&#39; % (key,repr(data)), type(data))</span>
        <span class="n">espace</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;espace&#39;</span><span class="p">]</span>
        <span class="n">enc</span>    <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span><span class="nb">bytearray</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">ebcdic</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">str2ebc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># PY2</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ebcdic</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">str2ebc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">mlen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">fieldlen</span><span class="p">)</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">mlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mlen</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fieldlen</span> <span class="o">&gt;</span> <span class="n">mlen</span><span class="p">:</span> <span class="c1"># fill rest of field with space character</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="n">mlen</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fieldlen</span><span class="o">-</span><span class="n">mlen</span><span class="p">)</span><span class="o">*</span> <span class="n">espace</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UTF16</span><span class="p">:</span>
        <span class="n">fieldlen</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)):</span> <span class="c1"># need to first convert to unicode</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">datalen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>  <span class="c1"># length in bytes</span>
        <span class="n">minlen</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span><span class="n">fieldlen</span><span class="p">)</span>
        <span class="n">padlen</span><span class="o">=</span><span class="p">(</span><span class="n">fieldlen</span><span class="o">-</span><span class="n">minlen</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">bo</span><span class="o">==</span><span class="n">NETWORKBO</span><span class="p">:</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">minlen</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">padlen</span>
                 <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf_16_be&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print( &#39;start=%d, stop=%d, minlen=%d, padlen=%d&#39; % (</span>
            <span class="c1">#    start, stop, minlen, padlen)</span>
            <span class="c1">#dump( (data[0:minlen]+u&#39; &#39;*padlen).encode(UTF16_NATIVE))</span>

            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">minlen</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">padlen</span>
                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">UTF16_NATIVE</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UTF8</span><span class="p">:</span>
        <span class="n">fieldlen</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="c1"># print( &#39;datamap setattr: key=%s, data=%s&#39; % (key,repr(data)), type(data))</span>
        <span class="n">sutf8</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span> \
            <span class="k">else</span> <span class="n">unicode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">datalen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sutf8</span><span class="p">)</span>
        <span class="n">minlen</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span><span class="n">fieldlen</span><span class="p">)</span>
        <span class="n">padlen</span><span class="o">=</span><span class="p">(</span><span class="n">fieldlen</span><span class="o">-</span><span class="n">minlen</span><span class="p">)</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">sutf8</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">minlen</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">padlen</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_PACK</span><span class="p">:</span>   <span class="c1"># packed decimal</span>
        <span class="n">fieldlen</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>

        <span class="k">if</span> <span class="n">ebcdic</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;f&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;c&#39;</span>

        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>    <span class="c1"># converting from datetime object</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="n">U0</span><span class="p">[:</span><span class="n">fieldlen</span><span class="p">]</span>                 <span class="c1"># None value is stored as zero</span>

            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATETIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d%02d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIMESTAMP&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d%02d%02d%02d%06d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%02d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATDATE&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date2natdate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">)),</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">date2natdate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATTIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp2nattime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)),</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">timestamp2nattime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">idata</span> <span class="o">=</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
               <span class="n">sign</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;d&#39;</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">idata</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idata</span><span class="p">),</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>         <span class="c1"># bytes() does not append L on long integer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span>

        <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">datalen</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">),</span><span class="n">bdata</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">fieldlen</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># 22 -&gt; 022F</span>
            <span class="n">nibble</span> <span class="o">=</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span>
        <span class="k">else</span><span class="p">:</span>                 <span class="c1"># 1  -&gt; 1F</span>
            <span class="n">nibble</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">fieldlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Packed: data size </span><span class="si">%d</span><span class="s1"> exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">datalen</span><span class="p">,</span><span class="n">fieldlen</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">bdata</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;...&#39;</span><span class="p">),</span> <span class="n">dmap</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datalen</span> <span class="o">&lt;</span> <span class="n">fieldlen</span><span class="p">:</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">fieldlen</span> <span class="o">-</span> <span class="n">datalen</span><span class="p">)</span> <span class="o">*</span> <span class="sa">b</span><span class="s1">&#39;00&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;start=</span><span class="si">%d</span><span class="s1">, stop=</span><span class="si">%d</span><span class="s1">, len=</span><span class="si">%d</span><span class="s1">, zeros=</span><span class="si">%r</span><span class="s1">, nibble=</span><span class="si">%r</span><span class="s1">, bdata=</span><span class="si">%r</span><span class="s1">, sign=</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">nibble</span><span class="p">,</span> <span class="n">bdata</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">unhexlify</span><span class="p">(</span><span class="n">zeros</span><span class="o">+</span><span class="n">nibble</span><span class="o">+</span><span class="n">bdata</span><span class="o">+</span><span class="n">sign</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">zeros</span><span class="o">+</span><span class="n">nibble</span><span class="o">+</span><span class="n">bdata</span><span class="o">+</span><span class="n">sign</span><span class="p">)</span>


    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UNPK</span><span class="p">:</span>   <span class="c1"># unpacked decimal</span>
        <span class="n">fieldlen</span><span class="o">=</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">ftype</span><span class="o">==</span><span class="n">T_UNPK</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dpack UNPK: fieldlen=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fieldlen</span><span class="p">)</span>
        <span class="n">sign</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>    <span class="c1"># converting from datetime object</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="n">U0</span><span class="p">[:</span><span class="n">fieldlen</span><span class="p">]</span>                 <span class="c1"># None value is stored as zero</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATETIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d%02d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIMESTAMP&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d%02d%02d%02d%06d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%04d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="si">%02d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATDATE&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date2nattime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATTIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp2nattime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">idata</span> <span class="o">=</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># long integers don&#39;t have L appended (but with repr())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ebcdic</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;=B&#39;</span><span class="p">,</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="n">idata</span><span class="o">%</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># last digit is a digit &#39;0&#39;-&#39;9&#39;</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="n">bdata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">last</span>             <span class="c1"># modify last byte</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idata</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">bdata</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># long integers don&#39;t have L appended (but with repr())</span>

        <span class="n">datalen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">ftype</span><span class="o">==</span><span class="n">T_UNPK</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dpack UNPK: data=</span><span class="si">%s</span><span class="s1"> datalen=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bdata</span><span class="p">,</span><span class="n">datalen</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ebcdic</span><span class="p">:</span>
            <span class="n">zero</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf0</span><span class="s1">&#39;</span>
            <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">datalen</span><span class="p">]</span> <span class="o">=</span> <span class="n">bdata</span>
            <span class="n">asc2ebc</span><span class="p">(</span><span class="n">sbuf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">datalen</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># fix last position if negative</span>
                <span class="n">sbuf</span><span class="p">[</span><span class="n">datalen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span> <span class="n">sbuf</span><span class="p">[</span><span class="n">datalen</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">&amp;</span> <span class="mh">0xdf</span><span class="p">)</span>  <span class="c1"># negative is 0xD-</span>

            <span class="n">bdata</span><span class="o">=</span><span class="n">sbuf</span><span class="p">[:</span><span class="n">datalen</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zero</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;0&#39;</span>

        <span class="k">if</span> <span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">fieldlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Unpacked: data size </span><span class="si">%d</span><span class="s1"> exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">, odata=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">datalen</span><span class="p">,</span><span class="n">fieldlen</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">bdata</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datalen</span> <span class="o">&lt;</span> <span class="n">fieldlen</span><span class="p">:</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">fieldlen</span> <span class="o">-</span> <span class="n">datalen</span><span class="p">)</span> <span class="o">*</span> <span class="n">zero</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zeros</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">ftype</span><span class="o">==</span><span class="n">T_UNPK</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">zeros</span><span class="p">),</span> <span class="n">zeros</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">bdata</span><span class="p">),</span> <span class="n">bdata</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">zeros</span><span class="o">+</span><span class="n">bdata</span>

    <span class="k">elif</span> <span class="n">ftype</span><span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
        <span class="n">fieldlen</span><span class="o">=</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span>
        <span class="c1"># print( type(data))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>    <span class="c1"># zero or empty bytes</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">fieldlen</span><span class="o">*</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">))):</span>  <span class="c1"># PY2/3</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data is negative key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">, length=</span><span class="si">%d</span><span class="s1">&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">),</span> <span class="n">dmap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fieldlen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;=B&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fieldlen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;datamap dpack() BYTE&#39;</span><span class="p">,</span> <span class="n">bo</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">dump</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">fieldlen</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffffffff</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fieldlen</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffffffffffffffff</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xdata</span><span class="o">=</span><span class="nb">hex</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># remove 0x prefix</span>
                <span class="k">if</span> <span class="n">xdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;L&#39;</span><span class="p">:</span>
                    <span class="n">xdata</span><span class="o">=</span><span class="n">xdata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># remove Long int indicator</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># hexstring uneven</span>
                    <span class="n">xdata</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="n">xdata</span>
                <span class="n">bdata</span><span class="o">=</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fieldlen</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr BYTE: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fieldlen</span><span class="p">:</span>
                    <span class="n">bdata</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">fieldlen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">bdata</span><span class="p">))</span> <span class="o">+</span> <span class="n">bdata</span>   <span class="c1"># prepend binary zeros</span>
                <span class="k">if</span> <span class="n">bo</span> <span class="o">==</span> <span class="n">NATIVEBO</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span><span class="s1">&#39;little&#39;</span><span class="p">:</span>
                    <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">swap</span><span class="p">(</span><span class="n">bdata</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">bdata</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">datalen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fieldlen</span> <span class="o">==</span> <span class="n">datalen</span><span class="p">:</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">data</span>
            <span class="k">elif</span> <span class="n">fieldlen</span> <span class="o">&gt;</span> <span class="n">datalen</span><span class="p">:</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">datalen</span><span class="p">]</span><span class="o">=</span><span class="n">data</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="n">datalen</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">fieldlen</span><span class="o">-</span><span class="n">datalen</span><span class="p">)</span><span class="o">*</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#  fieldlen &lt; datalen</span>
                <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">fieldlen</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UINT1</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">:</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># UINT1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Uint1: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_INT1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">))</span>
        <span class="k">if</span> <span class="o">-</span><span class="mh">0x80</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0x7f</span><span class="p">:</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># INT1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Int1: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
        <span class="c1"># dmap.buffer[start:stop]=struct.pack(&#39;=B&#39;, data) # &#39;=B&#39; or &#39;=b&#39;</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">T_UINT2</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># UINT2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Uint2: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_INT2</span><span class="p">:</span>
        <span class="k">if</span> <span class="o">-</span><span class="mh">0x8000</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0x7fff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># INT2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Int2: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UINT4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>    <span class="c1"># converting from datetime object</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span>                 <span class="c1"># None value is stored as zero</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;UNIXTIME&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">datetime2unixtime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span> <span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0xffffffff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># UINT4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Uint4: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_INT4</span><span class="p">:</span>
        <span class="k">if</span> <span class="o">-</span><span class="mh">0x80000000</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0x7fffffff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># INT4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Int4: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UINT8</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0xffffffffffffffff</span><span class="p">:</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># UINT8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Uint8: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_INT8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>    <span class="c1"># converting from datetime object</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span>                 <span class="c1"># None value is stored as zero</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;XTIMESTAMP&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">utc2xts</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">microsecond</span> <span class="p">)</span>

        <span class="k">if</span> <span class="o">-</span><span class="mh">0x8000000000000000</span> <span class="o">&lt;=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mh">0x7fffffffffffffff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="c1"># INT8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Int8: data exceeds field size </span><span class="si">%d</span><span class="s1">, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_CHAR</span><span class="p">:</span>
        <span class="n">enc</span>    <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span> <span class="c1"># PY3</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span><span class="nb">bytearray</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># PY2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>         <span class="c1"># already converted to EBCDIC</span>
            <span class="k">elif</span> <span class="n">ebcdic</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">str2ebc</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;datamap setattr Char: data exceeds 1 byte, key=</span><span class="si">%s</span><span class="s1">, data=</span><span class="si">%s</span><span class="s1">&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">dmap</span><span class="p">)</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
        <span class="c1"># print( bo, ftype, data, start, stop)</span>
        <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="n">ftype</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_CHAR</span> <span class="ow">and</span> <span class="n">ebcdic</span><span class="p">:</span>
            <span class="n">asc2ebc</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">)</span>


<div class="viewcode-block" id="dunpack"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.dunpack">[docs]</a><span class="k">def</span> <span class="nf">dunpack</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">possiz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; datamap unpack</span>

<span class="sd">    :param index: if index is &gt; 0: indexed access with constant field size&gt;0</span>
<span class="sd">        if possiz not given</span>
<span class="sd">    :param possiz: list of (pos, size) tuple indexed by index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">dataIsEbcdic</span><span class="p">,</span> <span class="n">sbuf</span>

    <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">possiz</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">possiz</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
        <span class="n">start</span><span class="o">+=</span><span class="n">dmap</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">pos</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">start</span><span class="o">+</span><span class="n">size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span><span class="o">+=</span><span class="n">dmap</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">indx</span><span class="o">*</span><span class="n">size</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">start</span><span class="o">+</span><span class="n">size</span>

    <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">indx</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.dunpack(</span><span class="si">%s</span><span class="s1">,indx=</span><span class="si">%r</span><span class="s1">) size=</span><span class="si">%d</span><span class="s1"> start=</span><span class="si">%d</span><span class="s1"> stop=</span><span class="si">%d</span><span class="s1"> offset=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">dmap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">dmap</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">dmap</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">possiz=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">possiz</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_STRING</span><span class="p">:</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">espace</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;espace&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dataIsEbcdic</span> <span class="ow">or</span> <span class="n">inout</span><span class="o">&amp;</span><span class="n">T_EBCDIC</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>  <span class="c1"># temp buffer too small?</span>
                        <span class="n">_t</span> <span class="o">=</span> <span class="n">sbuf</span>
                        <span class="n">sbuf</span> <span class="o">=</span> <span class="n">Abuf</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="c1"># reallocate in size needed</span>
                        <span class="k">del</span> <span class="n">_t</span>
                        <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
                <span class="n">ebc2asc</span><span class="p">(</span><span class="n">sbuf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># no other whitespace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;value=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UTF16</span><span class="p">:</span>  <span class="c1"># Unicode</span>
        <span class="k">global</span> <span class="n">byteOrder</span>
        <span class="k">if</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">NETWORKBO</span> <span class="ow">or</span> \
                            <span class="n">byteOrder</span><span class="o">==</span><span class="n">NETWORKBO</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf_16_be&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">UTF16_NATIVE</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UTF8</span><span class="p">:</span>   <span class="c1"># returns unicode string</span>
        <span class="n">_ret</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39; &#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_ret</span> <span class="o">=</span>  <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf_8&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># UnicodeDecodeError:</span>
            <span class="n">_ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Invalid UTF8 string &#39;</span><span class="o">+</span><span class="n">hexlify</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf_8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_ret</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_PACK</span><span class="p">:</span>   <span class="c1"># packed decimal</span>
        <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="c1"># supports also ebcdic packed</span>
        <span class="n">sign</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">hexbytes</span> <span class="o">=</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">])</span> <span class="c1"># bytes type in PY3</span>
        <span class="c1">#if sys.hexversion &gt;= 0x3010100:</span>
        <span class="c1">#    hexstr = hexbytes.decode()</span>
        <span class="c1">#else:</span>
        <span class="c1">#    hexstr = hexbytes</span>
        <span class="c1">#if hexstr[-1:].upper() in &#39;BD&#39;:</span>
        <span class="k">if</span> <span class="n">hexbytes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="sa">b</span><span class="s1">&#39;BD&#39;</span><span class="p">:</span>
            <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">):</span>    <span class="c1"># datetime output</span>
            <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">hexbytes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#size = len(hexstr)-1</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hexbytes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexbytes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">==</span> <span class="n">U0</span><span class="p">[:</span><span class="n">size</span><span class="p">]:</span>               <span class="c1"># Any datetime 0 value is returned as None</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">,</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">str2dt</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATDATE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="o">*</span><span class="n">natdate2date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATTIME&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">nattime2timestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">])))</span>

    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_UNPK</span><span class="p">:</span>   <span class="c1"># unpacked decimal</span>
        <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sbuf&#39;</span><span class="p">,</span><span class="n">sbuf</span><span class="p">[:</span><span class="n">size</span><span class="p">],</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">possiz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dataIsEbcdic</span>  <span class="ow">or</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_EBCDIC</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ebc2asc</span><span class="p">(</span><span class="n">sbuf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hx</span> <span class="o">=</span> <span class="n">hexlify</span><span class="p">(</span> <span class="n">sbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>   <span class="c1"># b&#39;F&#39;,b&#39;9&#39;</span>
            <span class="n">zone</span><span class="p">,</span><span class="n">lastdig</span> <span class="o">=</span> <span class="n">hx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span><span class="n">hx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># print(&#39;hx=%r, lastdig=%r, zone=%r&#39; % (hx,lastdig,zone,))</span>
            <span class="k">if</span> <span class="n">zone</span> <span class="ow">in</span> <span class="sa">b</span><span class="s1">&#39;BD&#39;</span><span class="p">:</span>
                <span class="n">sbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">unhexlify</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;7&#39;</span><span class="o">+</span><span class="n">lastdig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="n">unhexlify</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;3&#39;</span><span class="o">+</span><span class="n">lastdig</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>    <span class="c1"># datetime output</span>
            <span class="k">if</span> <span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]</span> <span class="o">==</span> <span class="n">U0</span><span class="p">[:</span><span class="n">size</span><span class="p">]:</span>               <span class="c1"># Any datetime 0 value is returned as None</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">,</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">str2dt</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATDATE&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="o">*</span><span class="n">natdate2date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NATTIME&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">nattime2timestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">])))</span>

        <span class="n">sign</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x3010100</span><span class="p">:</span>
            <span class="n">lastdig</span> <span class="o">=</span> <span class="n">sbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lastdig</span> <span class="o">&gt;</span> <span class="sa">b</span><span class="s1">&#39;9&#39;</span><span class="p">:</span>               <span class="c1"># &#39;9&#39; or  &#39;y&#39; (negative) = b&#39;\x39&#39; or b&#39;\x79&#39; (negative)</span>
                <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span>
            <span class="n">lastdig</span> <span class="o">=</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">lastdig</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>   <span class="c1"># b&#39;9&#39;</span>
            <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">sbuf</span><span class="p">[:</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lastdig</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lastdig</span> <span class="o">=</span> <span class="n">sbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">lastdig</span> <span class="o">&gt;</span> <span class="sa">b</span><span class="s1">&#39;9&#39;</span><span class="p">:</span>
                <span class="n">sign</span><span class="o">=-</span><span class="mi">1</span>
            <span class="n">lastdig</span> <span class="o">=</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">lastdig</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">sbuf</span><span class="p">[:</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lastdig</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># elif ftype == T_INT4:</span>
        <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_NWBO</span><span class="p">:</span>
            <span class="n">bo</span> <span class="o">=</span> <span class="n">NETWORKBO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bo</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>  <span class="c1"># if instance byteOrder in None take global</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ii</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="n">ftype</span><span class="p">,</span> <span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span> <span class="c1"># &#39;=l&#39;</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># struct.unpack error:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Invalid data for struct.unpack() type=</span><span class="si">%s</span><span class="s1">, offset=</span><span class="si">%4X</span><span class="s1">, length=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="o">-</span><span class="n">dmap</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>
            <span class="n">dump</span><span class="p">(</span><span class="n">dmap</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="c1"># print( &#39;getattr byteOrder+ftype&#39;, byteOrder+ftype, key, ii, type(ii))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_CHAR</span> <span class="ow">and</span> \
               <span class="p">(</span> <span class="n">dmap</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dataIsEbcdic</span> <span class="ow">or</span> <span class="n">inout</span><span class="o">&amp;</span><span class="n">T_EBCDIC</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">str2asc</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;UNIXTIME&#39;</span> <span class="ow">and</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_INT4</span><span class="p">,</span> <span class="n">T_INT8</span><span class="p">)</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">unix2utc</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;XTIMESTAMP&#39;</span> <span class="ow">and</span> <span class="n">ftype</span><span class="o">==</span><span class="n">T_INT8</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">xts2utc</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ii</span></div>


<div class="viewcode-block" id="Multiple"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Multiple">[docs]</a><span class="k">class</span> <span class="nc">Multiple</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Initialize with Multiple(supermap, key, occurs [, submap])</span>
<span class="sd">    if &#39;occurs&#39; is a function it will be called in prepare()</span>
<span class="sd">    to determine the actual occurrences before field access</span>

<span class="sd">    This class is used internally when defining fields with occurs&gt;0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">supermap</span><span class="p">,</span> <span class="n">superkey</span><span class="p">,</span> <span class="n">occurs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">submap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;supermap&#39;</span><span class="p">,</span><span class="n">supermap</span><span class="p">)</span>    <span class="c1"># datamap which defines element</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;superkey&#39;</span><span class="p">,</span><span class="n">superkey</span><span class="p">)</span>    <span class="c1"># key of element in supermap</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;submap&#39;</span><span class="p">,</span><span class="n">submap</span><span class="p">)</span>        <span class="c1"># optional datamap (e.g. Periodic)</span>
            <span class="c1"># object.__setattr__(self,&#39;startpos&#39;,datamap.keydict[superkey][1])</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;occfunc&#39;</span><span class="p">,</span><span class="n">occurs</span><span class="p">)</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="n">occurs</span><span class="p">)</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;possiz&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indx</span><span class="p">):</span>
        <span class="s2">&quot; currently only integers as index, no slice parameter!!!&quot;</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">indx</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>  <span class="c1"># debug</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Multiple</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.__getitem__(</span><span class="si">%d</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.__getitem__(</span><span class="si">%d</span><span class="s1">)&#39;</span>  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">indx</span><span class="p">))</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">indx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submap</span><span class="p">:</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submap</span>
                <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span>
                <span class="n">startpos</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># current position</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">buffer</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">buffer</span> <span class="c1"># copy buffer from enclosing datamap</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">possiz</span><span class="p">:</span>                   <span class="c1"># possiz list created in prepare()</span>
                    <span class="n">pos</span><span class="p">,</span> <span class="n">siz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possiz</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
                    <span class="n">sm</span><span class="o">.</span><span class="n">offset</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">startpos</span><span class="o">+</span><span class="n">pos</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sm</span><span class="o">.</span><span class="n">offset</span><span class="o">=</span><span class="n">dm</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">startpos</span><span class="o">+</span><span class="n">indx</span><span class="o">*</span><span class="n">sm</span><span class="o">.</span><span class="n">dmlen</span>
                <span class="k">return</span> <span class="n">sm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dunpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="n">indx</span><span class="p">,</span> <span class="n">possiz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">possiz</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> index </span><span class="si">%d</span><span class="s1"> is out of range 0 - </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s2">&quot; currently only integers as index, no slice parameter!!!&quot;</span>
        <span class="c1"># print( &#39;set one value indexed %s(%d)&#39; % (self.superkey, indx))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submap</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;Value assignment to datamap </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1">[</span><span class="si">%d</span><span class="s1">] invalid&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">indx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span> <span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">indx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span><span class="p">:</span>
            <span class="n">dpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="n">indx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">[</span><span class="si">%d</span><span class="s1">] index out of range 0 : </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">superkey</span><span class="p">,</span> <span class="n">indx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span></div>


<div class="viewcode-block" id="Datamap"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap">[docs]</a><span class="k">class</span> <span class="nc">Datamap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Datamap maps attributes to fields located in buffer+offset.</span>

<span class="sd">    This is similar to a struct in C and involves un-/packing to/from</span>
<span class="sd">    Python objects.</span>

<span class="sd">    It is used to handle data structures external to Python.</span>

<span class="sd">    Internally, attributes are defined as tuples per field list parameter</span>
<span class="sd">    and stored as keys in the dict &#39;keydict&#39; that contains tuples of</span>

<span class="sd">        - data_type,</span>
<span class="sd">        - slice_start,</span>
<span class="sd">        - slice_length,</span>
<span class="sd">        - read/write ability</span>
<span class="sd">        - function or method to convert to readable string</span>

<span class="sd">    The sequence of fields is maintained in the the list &#39;keylist&#39;</span>

<span class="sd">    Attribute tuples are generated with a list of data type specific</span>
<span class="sd">    functions. Each defines the attribute name and other field options</span>

<span class="sd">    Examples::</span>

<span class="sd">    &gt;&gt;&gt; from adapya.base.defs import Abuf</span>
<span class="sd">    &gt;&gt;&gt; from adapya.base.datamap import Datamap, String, Int2</span>
<span class="sd">    &gt;&gt;&gt; g = Datamap( &#39;mymap&#39;,String(&#39;foo&#39;, 6),Int2(&#39;bar&#39;) )</span>
<span class="sd">    &gt;&gt;&gt; g.buffer=Abuf(8)</span>

<span class="sd">    &gt;&gt;&gt; g.bar=255</span>
<span class="sd">    &gt;&gt;&gt; g.foo=&#39;abcdef&#39;</span>

<span class="sd">    &gt;&gt;&gt; print( g.foo)         # attribute access</span>
<span class="sd">    abcdef</span>

<span class="sd">    &gt;&gt;&gt; dump(g.buffer)      # contents of buffer</span>
<span class="sd">    Buffer</span>
<span class="sd">     0000 61626364 6566FF00                   abcdef..         /ÂÄÀÁÃ..</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    &gt;&gt;&gt; print( &#39;%(foo)s and %(bar)d&#39; % g)        # dictionary access</span>
<span class="sd">    abcdef and 255</span>

<span class="sd">    The following keywords are supported:</span>

<span class="sd">    - **buffer**  sets the buffer on which the datamap is mapped</span>
<span class="sd">    - **offset**  defines the offset in the buffer where the datamap starts</span>
<span class="sd">    - **encoding** sets the encoding to convert to/from Unicode (default &#39;Latin1&#39;)</span>
<span class="sd">    - **ebcdic**  if True: Alpha strings are in EBCDIC (encoding will be set to &#39;cp037&#39;</span>
<span class="sd">      if not encoding is not specified)</span>

<span class="sd">    - **byteOrder** define byte order for whole datamap (NETWORKBO or NATIVEBO)</span>
<span class="sd">    - **occurs**    multiple occurrence of datamap, e.g. PE group</span>
<span class="sd">      is a fixed number or an occurrence function, for example</span>

<span class="sd">          occurs=lambda:m1.occ - is a reference the occurrence count</span>

<span class="sd">    - **dmlen**</span>
<span class="sd">    - **varies**   indicates variable field positions and lengths</span>
<span class="sd">    - **supermap** enclosing datamap which provides defaults for buffer, offset etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dmname</span><span class="p">,</span> <span class="o">*</span><span class="n">fieldlist</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;espace&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># encoded space character in buffer (depends on encoding)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;buffer&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span>         <span class="c1"># encoding to convert to/from unicode</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmlen&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmname&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">dmname</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initix&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>         <span class="c1"># last field intitialized (index in keylist)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initdmlen&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;occurs&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;varies&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;supermap&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">,</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">,</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span><span class="s1">&#39;supermap&#39;</span><span class="p">,</span><span class="s1">&#39;varies&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;dmlen&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initdmlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;byteorder&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;Undefined keyword </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>
        <span class="n">ebc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">enc</span><span class="p">:</span>   <span class="c1"># no encoding set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]:</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="s1">&#39;cp037&#39;</span>               <span class="c1"># standard US EBCDIC</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="s1">&#39;latin_1&#39;</span>             <span class="c1"># standard ISO-8859-1</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ebc</span> <span class="ow">and</span> <span class="n">enc</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cp037&#39;</span><span class="p">,):</span>  <span class="c1"># asc2ebc and ebc2asc with std cp037/Latin1</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;espace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>    <span class="c1"># py2/3</span>

        <span class="n">newdic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fieldpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newdic</span>

        <span class="n">keysize</span><span class="o">=</span><span class="mi">0</span>       <span class="c1"># max. size of field name</span>
        <span class="n">capsize</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># caption size</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fieldlist</span><span class="p">:</span>
            <span class="c1"># key - field name, fty - field type, odict - field options</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">fty</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">odict</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">assert</span> <span class="n">key</span><span class="p">,</span><span class="s1">&#39;field must have a name in field definition </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">newdic</span><span class="p">,</span> <span class="s1">&#39;field name </span><span class="si">%r</span><span class="s1"> already defined in datamap&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>

            <span class="n">fieldopt</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">fdict</span><span class="o">=</span><span class="p">{}</span>                            <span class="c1"># field options</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">odict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">fdict</span> <span class="o">=</span> <span class="n">odict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>            <span class="c1"># shallow copy</span>

                <span class="c1"># evaluate special keywords and delete from fdict</span>
                <span class="k">if</span> <span class="s1">&#39;repos&#39;</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;repos&#39;</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">ipos</span><span class="p">,</span> <span class="s1">&#39;Datamap Field definition: repos must not be zero&#39;</span>
                    <span class="n">fieldpos</span><span class="o">+=</span><span class="n">ipos</span>
                    <span class="c1"># del fdict[&#39;repos&#39;]  # need repos for prepare when updating positions</span>
                <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">fieldpos</span><span class="o">=</span><span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">fieldopt</span><span class="o">|=</span><span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;dt&#39;</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">dtv</span> <span class="o">=</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dtv</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DATETIME&#39;</span><span class="p">,</span><span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">,</span><span class="s1">&#39;DATE&#39;</span><span class="p">,</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;NATDATE&#39;</span><span class="p">,</span><span class="s1">&#39;NATTIME&#39;</span><span class="p">,</span><span class="s1">&#39;UNIXTIME&#39;</span><span class="p">,</span><span class="s1">&#39;XTIMESTAMP&#39;</span><span class="p">):</span>
                        <span class="n">fieldopt</span><span class="o">|=</span><span class="n">T_DT</span>          <span class="c1"># convert to/from datetime() object</span>

            <span class="n">caption</span> <span class="o">=</span> <span class="n">fdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>   <span class="c1"># display title with dprint()</span>
            <span class="n">capsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">capsize</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">caption</span><span class="p">))</span> <span class="c1"># size of biggest caption</span>

            <span class="c1"># Use display column size if set otherwise the bigger of field size or field name</span>
            <span class="c1"># This is relevant for colum-wise print in lprint()</span>

            <span class="k">if</span> <span class="s1">&#39;colsize&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                <span class="n">sz</span> <span class="o">=</span> <span class="n">size</span>
                <span class="k">if</span> <span class="n">fty</span> <span class="o">==</span> <span class="n">T_BYTE</span> <span class="ow">or</span> <span class="n">fieldopt</span> <span class="o">&amp;</span> <span class="n">T_STCK</span> <span class="ow">or</span> <span class="n">fieldopt</span> <span class="o">&amp;</span> <span class="n">T_HEX</span><span class="p">:</span>
                    <span class="n">sz</span><span class="o">*=</span><span class="mi">2</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_UINT1</span><span class="p">,):</span>
                    <span class="n">sz</span><span class="o">=</span><span class="mi">3</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_INT1</span><span class="p">,):</span>
                    <span class="n">sz</span><span class="o">=</span><span class="mi">4</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_UINT2</span><span class="p">,):</span>
                    <span class="n">sz</span><span class="o">=</span><span class="mi">5</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_INT2</span><span class="p">,):</span>
                    <span class="n">sz</span><span class="o">=</span><span class="mi">6</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_INT4</span><span class="p">,</span> <span class="n">T_UINT4</span><span class="p">,</span> <span class="n">T_UINT8</span><span class="p">,</span> <span class="n">T_INT8</span><span class="p">):</span>
                    <span class="n">sz</span><span class="o">=</span><span class="mi">10</span>
                <span class="k">elif</span> <span class="n">fty</span> <span class="o">==</span> <span class="n">T_PACK</span><span class="p">:</span>
                    <span class="n">sz</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">fieldopt</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>
                    <span class="n">sz</span> <span class="o">=</span> <span class="mi">19</span>           <span class="c1"># datetime() str() 9999-12-31 23:59:59</span>
                    <span class="c1"># sz = 26         # with microsecond</span>

                <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;colsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;initsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">0</span>  <span class="c1">#  current size == 0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fty</span> <span class="o">==</span> <span class="n">T_UTF16</span><span class="p">:</span>
                    <span class="n">size</span><span class="o">*=</span><span class="mi">2</span>                   <span class="c1"># each unicode char is 2 bytes</span>
                <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;initsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldopt</span><span class="o">&amp;</span><span class="n">T_INOUT</span><span class="p">:</span>
                <span class="n">fieldopt</span><span class="o">|=</span><span class="n">T_INOUT</span>             <span class="c1"># if neither IN/OUT set default to INOUT</span>

            <span class="n">newdic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fty</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fieldopt</span><span class="p">,</span> <span class="n">fdict</span><span class="p">]</span>

            <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">occurs</span> <span class="o">=</span> <span class="n">fdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">occurs</span><span class="p">:</span>
                <span class="n">fds</span> <span class="o">=</span> <span class="n">fdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;submap&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>   <span class="c1"># sub datamap i.e. Periodic</span>
                <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;submap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">occurs</span><span class="p">,</span> <span class="n">submap</span><span class="o">=</span><span class="n">fds</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">fds</span><span class="p">:</span>
                    <span class="n">fds</span><span class="o">.</span><span class="n">supermap</span><span class="o">=</span><span class="bp">self</span>
                    <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">size</span>          <span class="c1"># Periodic: size is already dmlen*occurs or 0 if variable</span>
                    <span class="k">if</span> <span class="n">fds</span><span class="o">.</span><span class="n">varies</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">varies</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                    <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">occurs</span> <span class="c1"># Multiple field</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1">#</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">varies</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fieldpos</span><span class="o">+=</span><span class="n">size</span>

            <span class="k">if</span> <span class="n">keysize</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="c1"># width of attribute name for printing</span>
                <span class="n">keysize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;varies&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># mark datamap varies in size</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmlen&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fieldpos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldpos</span>     <span class="c1"># total size of all fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initdmlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldpos</span> <span class="c1"># total size of all fields</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keylist</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keysize</span>  <span class="c1"># max size of attribute name</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;capsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capsize</span>  <span class="c1"># max size of caption</span>

        <span class="c1"># print( self.__dict__[&#39;keydict&#39;])</span>

<div class="viewcode-block" id="Datamap.getsize"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.getsize">[docs]</a>    <span class="k">def</span> <span class="nf">getsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;:returns: size of datamap&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmlen&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Datamap.prepare"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prepare datamap for field access.</span>

<span class="sd">        This function must be called if datamap contains</span>
<span class="sd">        variable fields or variable number of occurences.</span>

<span class="sd">        It sets the exact field position [1] and size [2] in the field</span>
<span class="sd">        definition list so that field access can use it.</span>

<span class="sd">        For variable length fields position/size excludes the length part</span>
<span class="sd">        initsize - stores the initial size (=0 for variable fields).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">INDENT</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.prepare() with dmlen=</span><span class="si">%d</span><span class="s1"> varies=</span><span class="si">%d</span><span class="s1"> buffer=</span><span class="si">%r</span><span class="s1"> offset=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">varies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>
            <span class="n">INDENT</span><span class="o">+=</span><span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">varies</span><span class="p">:</span>     <span class="c1"># nothing to do if no variable components</span>
            <span class="k">return</span>

        <span class="n">fieldpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">fieldpos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="n">keylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
            <span class="n">fdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

            <span class="n">ftype</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span> <span class="o">=</span> <span class="n">fdef</span>

            <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repos&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fieldpos</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>     <span class="c1"># update current field position</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;updating </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> pos from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">))</span>

                <span class="n">fdef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldpos</span>

            <span class="n">size</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initsize&#39;</span><span class="p">)</span>   <span class="c1"># could be number or function</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;submap&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># Multiple field or PE group</span>
                                 <span class="c1"># Note: Multiple has length function!</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fdef</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_DMAP</span><span class="p">:</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">submap</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare: if submap </span><span class="si">%s</span><span class="s1"> varies=</span><span class="si">%d</span><span class="s1">, dmlen=</span><span class="si">%d</span><span class="s1">: call prepare()&#39;</span> <span class="o">%</span><span class="p">(</span>
                                        <span class="n">sm</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span><span class="n">sm</span><span class="o">.</span><span class="n">varies</span><span class="p">,</span><span class="n">sm</span><span class="o">.</span><span class="n">dmlen</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sm</span><span class="o">.</span><span class="n">varies</span><span class="p">:</span>
                        <span class="n">size</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">dmlen</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sm</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare: after calling prepare for&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">dmlen</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">varies</span><span class="p">)</span>

                <span class="n">occfunc</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occfunc&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">occfunc</span><span class="p">:</span>

                    <span class="n">occurs</span> <span class="o">=</span> <span class="n">occfunc</span><span class="p">()</span>  <span class="c1"># current number of occurrences</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare: mupex=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">occurs</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">occurs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>      <span class="c1"># occurrence counter before field, abs(occurs) is size of counter</span>
                        <span class="k">assert</span> <span class="o">-</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">occurs</span><span class="p">,</span><span class="s1">&#39;Invalid MUPE size </span><span class="si">%d</span><span class="s1">, only 1 or 2 defined&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">occurs</span><span class="p">),)</span>

                        <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">occurs</span>  <span class="c1"># byte position before MU field or PE group</span>
                        <span class="n">copt</span> <span class="o">=</span> <span class="n">T_MUPE</span><span class="o">|</span><span class="n">T_VAR1</span> <span class="k">if</span> <span class="n">occurs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">T_MUPE</span><span class="o">|</span><span class="n">T_VAR2</span>

                        <span class="n">fieldpos</span><span class="p">,</span><span class="n">occurs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpossiz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">copt</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">)</span>  <span class="c1"># i = field element in datamap</span>

                    <span class="n">mu</span><span class="o">.</span><span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">occurs</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># fixed number</span>

                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare: key=</span><span class="si">%s</span><span class="s1">, fieldpos=</span><span class="si">%d</span><span class="s1">, occurs=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">k</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T_VAR0</span> <span class="o">|</span> <span class="n">T_VAR1</span> <span class="o">|</span> <span class="n">T_VAR2</span> <span class="o">|</span> <span class="n">T_VAR4</span><span class="p">):</span> <span class="c1"># this is a variable field</span>
                    <span class="n">possiz</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                        <span class="n">fieldpos</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpossiz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">)</span> <span class="c1"># i = field element index in datamap</span>
                        <span class="n">possiz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fieldpos</span><span class="p">,</span><span class="n">size</span><span class="p">))</span>

                    <span class="n">fdic</span><span class="p">[</span><span class="s1">&#39;possiz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">possiz</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;prepare: key=</span><span class="si">%s</span><span class="s1">, fieldpos=</span><span class="si">%d</span><span class="s1">, size=</span><span class="si">%d</span><span class="s1">, occurs=</span><span class="si">%d</span><span class="s1">, totalsize=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                                 <span class="n">k</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">occurs</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">occurs</span><span class="p">))</span>
                    <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">occurs</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># single field</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">T_VAR0</span> <span class="o">|</span> <span class="n">T_VAR1</span> <span class="o">|</span> <span class="n">T_VAR2</span> <span class="o">|</span> <span class="n">T_VAR4</span><span class="p">):</span> <span class="c1"># this is a variable field</span>
                    <span class="n">fieldpos</span><span class="p">,</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpossiz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">)</span> <span class="c1"># i = field element index in datamap</span>

                    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">sz</span><span class="p">:</span>
                        <span class="n">fdef</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
                    <span class="k">if</span> <span class="n">fieldpos</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>     <span class="c1"># update current field position to data portion</span>
                        <span class="n">fdef</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldpos</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="n">k</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">sz</span><span class="p">)</span>
                <span class="n">fieldpos</span> <span class="o">+=</span> <span class="n">size</span>

        <span class="k">if</span> <span class="n">fieldpos</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmlen</span><span class="p">:</span>     <span class="c1"># update current dmlen</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;updating </span><span class="si">%s</span><span class="s1">.dmlen from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmlen</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dmlen</span> <span class="o">=</span> <span class="n">fieldpos</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">INDENT</span> <span class="o">=</span> <span class="n">INDENT</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span></div>


<div class="viewcode-block" id="Datamap.getpossiz"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.getpossiz">[docs]</a>    <span class="k">def</span> <span class="nf">getpossiz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine position and size in variable field or</span>
<span class="sd">            occ. count before MU/PE field ( opt &amp; T_MUPE)</span>

<span class="sd">            called from prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span>

        <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">pm</span><span class="p">:</span>               <span class="c1"># find outmost datamap for buffer and offsets</span>
            <span class="n">ppm</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">supermap</span>
            <span class="k">if</span> <span class="n">ppm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">ppm</span>

        <span class="k">if</span> <span class="n">bo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bo</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">byteOrder</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">fieldpos</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">offset</span>


        <span class="n">keylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">keylist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">fdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ftype</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span> <span class="o">=</span> <span class="n">fdef</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">INDENT</span>
            <span class="n">INDENT</span> <span class="o">+=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.getpossiz() for </span><span class="si">%s</span><span class="s1"> start </span><span class="si">%d</span><span class="s1"> = fieldpos </span><span class="si">%d</span><span class="s1"> + offset </span><span class="si">%d</span><span class="s1"> bo=</span><span class="si">%s</span><span class="s1"> in buffer </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">bo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_VAR1</span><span class="p">:</span>
            <span class="n">size</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="n">T_UINT1</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_MUPE</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span>   <span class="c1"># minus 1</span>
            <span class="n">fieldpos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_VAR2</span><span class="p">:</span>
            <span class="n">size</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="n">T_UINT2</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_MUPE</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">fieldpos</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_VAR4</span><span class="p">:</span>
            <span class="n">size</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">bo</span><span class="o">+</span><span class="n">T_UINT4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span>
            <span class="n">fieldpos</span> <span class="o">+=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_VAR0</span><span class="p">:</span>

            <span class="n">fun</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sizefunc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">)):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">fun</span><span class="p">()</span> <span class="c1"># call interpretation</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fun(): </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">):</span> <span class="c1"># variable/const</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">fun</span> <span class="c1"># get the value</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fun(): </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">INDENT</span> <span class="o">=</span> <span class="n">INDENT</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">fieldpos</span><span class="p">,</span> <span class="n">size</span></div>


<div class="viewcode-block" id="Datamap.rippledown"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.rippledown">[docs]</a>    <span class="k">def</span> <span class="nf">rippledown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">parm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply function to lower datamaps</span>
<span class="sd">            no data is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
            <span class="n">fdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

            <span class="n">ftype</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span> <span class="o">=</span> <span class="n">fdef</span>

            <span class="n">mu</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;submap&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># Multiple field or PE group</span>
                                 <span class="c1"># Note: Multiple has length function!</span>
                <span class="c1"># print( INDENT, &#39;rippledown:&#39;, self.dmname, k, fdef)</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_DMAP</span><span class="p">:</span>
                    <span class="n">sm</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">submap</span>
                    <span class="c1"># print( INDENT, &#39;rippledown(): %s calling %s&#39; %(sm.dmname, fun))</span>
                    <span class="n">smfun</span> <span class="o">=</span>  <span class="nb">getattr</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span><span class="n">fun</span><span class="p">)</span>
                    <span class="n">smfun</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">setByteOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">NETWORKBO</span><span class="p">:</span>
            <span class="n">bo</span> <span class="o">=</span> <span class="n">byteorder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bo</span> <span class="o">=</span> <span class="n">NATIVEBO</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bo</span>

            <span class="c1"># print(&#39;calling rippledown in setByetOrder(%s, %r)&#39; %(self.dmname,bo))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rippledown</span><span class="p">(</span><span class="s1">&#39;setByteOrder&#39;</span><span class="p">,</span> <span class="n">bo</span><span class="p">)</span> <span class="c1"># set it in submaps</span>

        <span class="c1"># print( &#39;setByteOrder()&#39; , self.byteOrder)</span>

<div class="viewcode-block" id="Datamap.setEbcdic"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.setEbcdic">[docs]</a>    <span class="k">def</span> <span class="nf">setEbcdic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yesno</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set String/Char data to EBDIC in datamap</span>

<span class="sd">        This method also overrides any encoding with &#39;cp037&#39; for EBCDIC or</span>
<span class="sd">        &#39;Latin_1&#39; for not EBCDIC.</span>

<span class="sd">        :param yesno: 0 to switch to EBCDIC or 1 to switch to ASCII</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ebc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ebc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yesno</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># already set to ebcdic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># switch off ebcdic</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;latin_1&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yesno</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cp037&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;ebcdic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># print(&#39;calling rippledown in setEbcdic(%s, %r)&#39; %(self.dmname,yesno))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rippledown</span><span class="p">(</span><span class="s1">&#39;setEbcdic&#39;</span><span class="p">,</span> <span class="n">yesno</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">setNativeByteOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">NATIVEBO</span>
        <span class="c1"># print( &#39;setNativeByteOrder()&#39; , self.byteOrder)</span>

    <span class="k">def</span> <span class="nf">setNetworkByteOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;byteOrder&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">NETWORKBO</span>
        <span class="c1"># print( &#39;setNetworkByteOrder()&#39;, self.byteOrder)</span>

<div class="viewcode-block" id="Datamap.setfsize"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.setfsize">[docs]</a>    <span class="k">def</span> <span class="nf">setfsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">newsize</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; set new fieldsize</span>
<span class="sd">            Note: offsets of the following fields are not adjusted!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">newsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span><span class="p">)</span></div>

<div class="viewcode-block" id="Datamap.dprint"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.dprint">[docs]</a>    <span class="k">def</span> <span class="nf">dprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">proff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">selectfields</span><span class="o">=</span><span class="p">(),</span> <span class="n">skipnull</span><span class="o">=</span><span class="mi">0</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print detail lines with all attributes</span>

<span class="sd">        :param proff:  1 = print offset when walking through buffers</span>
<span class="sd">        :parm selectfields: display only fields listed (optional)</span>
<span class="sd">        :parm skipnull: 1 = do not display empty fields</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indstr</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmname&#39;</span><span class="p">]</span>

        <span class="c1">#o replication buffer specifics: move to urb/reptor code:</span>
        <span class="c1">#o  override function dprint()</span>
        <span class="sd">&quot;&quot;&quot; change the following</span>
<span class="sd">        eye = self.buffer[self.offset:self.offset+4]</span>
<span class="sd">        global dataIsEbcdic</span>
<span class="sd">        if self.__dict__[&#39;ebcdic&#39;] or dataIsEbcdic:</span>
<span class="sd">          eye = str2asc(eye)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proff</span><span class="p">:</span>
            <span class="n">offstr</span> <span class="o">=</span> <span class="s2">&quot; at offset X&#39;</span><span class="si">%04X</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>  <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offstr</span><span class="p">))</span>

        <span class="n">ks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capsize</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">keysize</span>
        <span class="c1"># use keysize if capsize==0 i.e. no caption was defined</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_NONE</span><span class="p">:</span>    <span class="c1"># do not display filler fields</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">selectfields</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selectfields</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

            <span class="n">ostr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="c1"># data value or Multiple()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">Multiple</span><span class="p">):</span>  <span class="c1"># this can be MU field or a PE group</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">T_DMAP</span><span class="p">:</span>             <span class="c1"># PE Group</span>
                    <span class="nb">print</span><span class="p">()</span>  <span class="c1"># separating empty line</span>
                    <span class="n">ostr</span><span class="o">.</span><span class="n">submap</span><span class="o">.</span><span class="n">lprint</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ostr</span><span class="p">:</span>
                        <span class="n">i</span><span class="o">.</span><span class="n">lprint</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="n">proff</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>  <span class="c1"># separating empty line</span>
                    <span class="k">continue</span>                <span class="c1"># finished with this element</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>                    <span class="c1">#open: iterate the MU field</span>

            <span class="k">if</span> <span class="n">skipnull</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ostr</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ostr</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">fun</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ppfunc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                <span class="n">dstr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span> <span class="c1"># method</span>
                <span class="n">dstr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation ???no self</span>

            <span class="n">kk</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c1"># use caption as title or key</span>

            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_STRING</span><span class="p">,</span> <span class="n">T_BYTE</span><span class="p">,</span> <span class="n">T_CHAR</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="s2">&quot;X&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">rawhex</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ostr</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="o">*</span><span class="n">y</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s%-*s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ostr</span><span class="p">,</span> <span class="n">dstr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ostr</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">y</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ostr=repr(ostr)[1:-1]  # omit double quotes</span>
                        <span class="k">pass</span>
                    <span class="c1"># print( &#39;%s%-*s = %r %s&#39; % (indstr, ks, kk, ostr, dstr))  # remove single quotes from repr()</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s%-*s</span><span class="s2"> = &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ostr</span><span class="p">,</span> <span class="n">dstr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_STCK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT4</span><span class="p">:</span>
                        <span class="n">ostr</span> <span class="o">=</span> <span class="n">sstck</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># should be T_UINT8</span>
                        <span class="n">ostr</span> <span class="o">=</span> <span class="n">sstckd</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                <span class="k">if</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_HEX</span><span class="p">:</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="s2">&quot;X&#39;</span><span class="si">%0*X</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">ostr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dstr</span><span class="p">:</span>                                                  <span class="c1"># result of function call</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s%-*s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">dstr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>                                                     <span class="c1"># not string/byte/function</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%s%-*s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">ostr</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span></div>

<div class="viewcode-block" id="Datamap.items"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectfields</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Return list of name value pairs on the fields in datamap</span>

<span class="sd">           Restriction: no composite fields</span>

<span class="sd">           :todo: check if byte arrays/fields can be used when handling bytes</span>

<span class="sd">        &gt;&gt;&gt; from adapya.base.datamap import Datamap, String, Int2</span>
<span class="sd">        &gt;&gt;&gt; g = Datamap( &#39;mymap&#39;,String(&#39;foo&#39;, 6),Int2(&#39;bar&#39;) )</span>
<span class="sd">        &gt;&gt;&gt; from adapya.base.defs import Abuf</span>
<span class="sd">        &gt;&gt;&gt; g.buffer=Abuf(8)</span>
<span class="sd">        &gt;&gt;&gt; g.bar=255</span>
<span class="sd">        &gt;&gt;&gt; g.foo=&#39;abcdef&#39;</span>
<span class="sd">        &gt;&gt;&gt; g.items()</span>
<span class="sd">        [(&#39;foo&#39;, &#39;abcdef&#39;), (&#39;bar&#39;, 255)]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">myitems</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_NONE</span><span class="p">:</span>    <span class="c1"># do not display filler fields</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">selectfields</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selectfields</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ostr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">Multiple</span><span class="p">):</span>  <span class="c1"># this can be MU field or a PE group</span>
                <span class="k">continue</span>

            <span class="n">fun</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ppfunc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fun</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span> <span class="c1"># method</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation ???no self</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
                <span class="n">ostr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">ostr</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ostr</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="o">*</span><span class="n">y</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_STCK</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT4</span><span class="p">:</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">stck</span><span class="o">.</span><span class="n">sstck</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mi">19</span><span class="p">)</span>         <span class="c1"># adapt column size if blank</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT8</span><span class="p">:</span> <span class="c1"># should be T_UINT8</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">stck</span><span class="o">.</span><span class="n">sstckd</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span> <span class="k">if</span> <span class="s1">&#39;colsize&#39;</span> <span class="ow">in</span> <span class="n">fdic</span> <span class="k">else</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># adapt column size if blank</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_HEX</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_STRING</span><span class="p">,</span> <span class="n">T_CHAR</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">):</span>
                <span class="n">ostr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%0*X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">ostr</span><span class="p">)</span>

            <span class="n">myitems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ostr</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">myitems</span></div>



<div class="viewcode-block" id="Datamap.lprint"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.lprint">[docs]</a>    <span class="k">def</span> <span class="nf">lprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">proff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">selectfields</span><span class="o">=</span><span class="p">(),</span> <span class="n">col1</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print line with all attributes in one line with</span>

<span class="sd">        :param header: 1: print only header</span>
<span class="sd">        :param indent: Columns to indent (default = 0)</span>
<span class="sd">        :param proff:  1: print offset when walking through buffers</span>
<span class="sd">        :param selectfields: display only fields listed (optional)</span>
<span class="sd">        :param col1: prefix text as first column (use to add index numbers to line)</span>
<span class="sd">            Header and detail line should pass same string length</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indstr</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;dmname&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proff</span><span class="p">:</span>
                <span class="n">offstr</span> <span class="o">=</span> <span class="s2">&quot; at offset X&#39;</span><span class="si">%04X</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>  <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="n">indstr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offstr</span><span class="p">))</span>

            <span class="c1"># print(&#39;header indstr = %r col1 = %r&#39; % (indstr,col1))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">indstr</span><span class="o">+</span><span class="n">col1</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># column size determined by max. caption and field length</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]:</span>
                <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_NONE</span><span class="p">:</span>    <span class="c1"># do not display filler fields</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">selectfields</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selectfields</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">kk</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c1"># use field caption or key</span>

                <span class="k">if</span> <span class="s1">&#39;colsize&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                    <span class="n">cs</span><span class="o">=</span><span class="n">fdic</span><span class="p">[</span><span class="s1">&#39;colsize&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_STCK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT4</span><span class="p">:</span>
                        <span class="n">stcksz</span> <span class="o">=</span> <span class="mi">19</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stcksz</span> <span class="o">=</span> <span class="mi">30</span>
                    <span class="n">cs</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;colsize&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)),</span> <span class="n">stcksz</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">t</span>  <span class="ow">in</span> <span class="p">(</span><span class="n">T_STRING</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">):</span>   <span class="c1"># strings left aligned</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%-*s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">kk</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>                                   <span class="c1"># numeric values right aligned</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">kk</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">()</span>
            <span class="k">return</span>  <span class="c1"># --- end of header print ---</span>

        <span class="nb">print</span><span class="p">(</span> <span class="n">indstr</span><span class="o">+</span><span class="n">col1</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># print line with all fields</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">opt</span><span class="p">,</span><span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="c1">#if k == &#39;cmdt&#39;:</span>
            <span class="c1">#    print( &#39;k =&#39;,k, t, x, y, opt, fdic, self.__getattr__(k))</span>

            <span class="k">if</span> <span class="n">opt</span> <span class="o">&amp;</span> <span class="n">T_NONE</span><span class="p">:</span>    <span class="c1"># do not display filler fields</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">selectfields</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selectfields</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ostr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">Multiple</span><span class="p">):</span>  <span class="c1"># this can be MU field or a PE group</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">T_DMAP</span><span class="p">:</span>             <span class="c1"># PE Group</span>
                    <span class="n">ostr</span><span class="o">.</span><span class="n">supermap</span><span class="o">.</span><span class="n">lprint</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ostr</span><span class="p">:</span>
                        <span class="n">i</span><span class="o">.</span><span class="n">lprint</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">continue</span>                <span class="c1"># finished with this element</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>                    <span class="c1">#open: iterate the MU field</span>

            <span class="n">kk</span><span class="o">=</span><span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>        <span class="c1"># use column header if defined</span>
            <span class="n">cs</span><span class="o">=</span><span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;colsize&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">))</span> <span class="c1"># column size</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ppfunc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fun</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span> <span class="c1"># method</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="c1"># call interpretation ???no self</span>
                <span class="n">cs</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
                <span class="n">ostr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hexlify</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ostr</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="o">*</span><span class="n">y</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_STCK</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT4</span><span class="p">:</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">sstck</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="mi">19</span><span class="p">)</span>         <span class="c1"># adapt column size if blank</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">==</span><span class="n">T_UINT8</span><span class="p">:</span> <span class="c1"># should be T_UINT8</span>
                    <span class="n">ostr</span> <span class="o">=</span> <span class="n">sstckd</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span><span class="n">gmt</span><span class="o">=</span><span class="n">opt</span><span class="o">&amp;</span><span class="n">T_GMT</span><span class="p">)</span> <span class="c1"># local time if T_GMT not set</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="n">cs</span> <span class="k">if</span> <span class="s1">&#39;colsize&#39;</span> <span class="ow">in</span> <span class="n">fdic</span> <span class="k">else</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># adapt column size if blank</span>
            <span class="k">elif</span> <span class="n">opt</span><span class="o">&amp;</span><span class="n">T_HEX</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_STRING</span><span class="p">,</span> <span class="n">T_CHAR</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">,</span> <span class="n">T_UTF16</span><span class="p">):</span>
                <span class="n">ostr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%0*X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="n">ostr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">LEFT_ALIGNED</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%-*s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ostr</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="si">%*s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ostr</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>      <span class="c1"># left align</span>
        <span class="nb">print</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="c1"># function will only be called if normal instance attribute lookup fails</span>
        <span class="c1"># e.g. self.buffer would not come here because it is initalized (to None) in</span>
        <span class="c1"># self.__dict__</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">:</span>
            <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="n">INDENT</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.__getattr__()</span><span class="se">\n\t</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmname</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;submap&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fdic</span><span class="p">[</span><span class="s1">&#39;submap&#39;</span><span class="p">]</span>     <span class="c1"># return Multiple/Datamap object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dunpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span><span class="p">:</span>
                <span class="c1"># locate buffer and offset in outmost datamap that encloses datamap self</span>
                <span class="n">pmfirst</span> <span class="o">=</span> <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supermap</span>
                <span class="k">while</span> <span class="n">pm</span> <span class="p">:</span>
                    <span class="n">pm</span><span class="p">,</span> <span class="n">pmfirst</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">supermap</span><span class="p">,</span> <span class="n">pm</span>
                <span class="k">return</span> <span class="n">dunpack</span><span class="p">(</span><span class="n">pmfirst</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="s2">&quot;Dictionary type of usage: b[&#39;str&#39;]&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="s2">&quot;Dictionary type of usage: b[&#39;str&#39;]=&#39;abcde&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">dataIsEbcdic</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">:</span>
            <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_IN</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> must not be modified&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;submap&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                <span class="c1"># Only come here if d.mufield = (val1,val2)</span>
                <span class="c1"># d.mufield[1] = value is resolved as</span>
                <span class="c1">#    d.__getitem__() returning submap object (e.g. Multiple) followed by</span>
                <span class="c1">#    submap.__setitem__()</span>
                <span class="n">occurs</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                    <span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">()</span>
                <span class="c1"># elif isinstance(occurs, (list,tuple)): # todo</span>
                <span class="c1">#   get and set occ functions given: set occurrences function</span>
                <span class="c1">#   to update occurrence count or Format with index range</span>

                <span class="k">if</span> <span class="n">occurs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">occurs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="n">dpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;Assignment to submap/multiple </span><span class="si">%s</span><span class="s1"> only for tuples/list with size </span><span class="si">%d</span><span class="s1"> &lt; max occurrence </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">occurs</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;Assignment to submap/multiple </span><span class="si">%s</span><span class="s1"> only for tuples/list, given </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>  <span class="c1"># key must be defined at class init</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DatamapError</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> not defined in Datamap&#39;</span><span class="o">%</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Datamap.genfb"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.genfb">[docs]</a>    <span class="k">def</span> <span class="nf">genfb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate Format buffer from datamap with fields defining Adabas</span>
<span class="sd">        field name with options fn</span>

<span class="sd">        datamap instance must have field name *fn* added to the options</span>
<span class="sd">        dict of each field</span>

<span class="sd">        :returns: string with format buffer contents</span>

<span class="sd">        Note: currently limited to normal fields - no PE/MU support</span>

<span class="sd">        &gt;&gt;&gt; from adapya.base.datamap import Datamap,Int2,String</span>
<span class="sd">        &gt;&gt;&gt; g = Datamap(&#39;mymap&#39;,String(&#39;foo&#39;,6,fn=&#39;AA&#39;),Int2(&#39;bar&#39;,fn=&#39;AB&#39;,occurs=3))</span>
<span class="sd">        &gt;&gt;&gt; g.genfb()</span>
<span class="sd">        &#39;AA,6,A,AB,2,F.&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">_io</span> <span class="k">import</span> <span class="n">StringIO</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="k">import</span> <span class="n">StringIO</span>
        <span class="n">fbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keylist&#39;</span><span class="p">]:</span>
            <span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fbuf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="c1"># separate from previous field</span>
            <span class="k">if</span> <span class="s1">&#39;fn&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fdic</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># (fixed) occurrences or zero</span>
                <span class="k">if</span> <span class="n">occ</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">occ</span> <span class="o">=</span> <span class="s1">&#39;1-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">occ</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">occ</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="n">ffrm</span> <span class="o">=</span> <span class="n">DM2ADAF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ffrm</span><span class="p">:</span>
                    <span class="n">fbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">occ</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">ffrm</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">size</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">X&#39;</span> <span class="o">%</span> <span class="n">size</span> <span class="p">)</span> <span class="c1"># field name not found: leave empty</span>

        <span class="n">fbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># close format buffer field list</span>
        <span class="n">fbs</span><span class="o">=</span><span class="n">fbuf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fbs</span> <span class="c1"># return prepared format buffer string</span></div>

<div class="viewcode-block" id="Datamap.getfndef"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.getfndef">[docs]</a>    <span class="k">def</span> <span class="nf">getfndef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get Adabas field definition from datamap</span>

<span class="sd">        :returns: tuple Adabas (field name, length, format)</span>
<span class="sd">               or None if name does not exist or field name not found</span>

<span class="sd">        &gt;&gt;&gt; g = Datamap( &#39;mymap&#39;,String(&#39;foo&#39;,6,fn=&#39;AA&#39;),Int2(&#39;bar&#39;,fn=&#39;AB&#39;) )</span>
<span class="sd">        &gt;&gt;&gt; g.getfndef(&#39;foo&#39;)</span>
<span class="sd">        (&#39;AA&#39;, 6, &#39;A&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fdef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;keydict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fdef</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span><span class="p">)</span> <span class="o">=</span> <span class="n">fdef</span>
            <span class="k">if</span> <span class="s1">&#39;fn&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fdic</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span>
                <span class="n">ffrm</span> <span class="o">=</span> <span class="n">DM2ADAF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">ffrm</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Datamap.reset"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset attributes/key values of a datamap to default values</span>
<span class="sd">        if buffer variable is set::</span>

<span class="sd">            &gt;&gt; adac.cb.reset()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span> <span class="c1"># can only reset values if buffer is underlying</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keylist</span><span class="p">:</span>    <span class="c1"># go from left to right</span>
                <span class="n">ftype</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">inout</span><span class="p">,</span> <span class="n">fdic</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keydict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_IN</span><span class="p">):</span>
                    <span class="k">continue</span>    <span class="c1"># do not reset input only fields</span>

                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_STRING</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">T_UTF16</span><span class="p">,</span> <span class="n">T_UTF8</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_BYTE</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="n">T_CHAR</span><span class="p">:</span> <span class="c1"># one character</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                <span class="k">else</span><span class="p">:</span>   <span class="c1"># numeric type</span>
                    <span class="k">if</span> <span class="n">inout</span> <span class="o">&amp;</span> <span class="n">T_DT</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="s1">&#39;submap&#39;</span> <span class="ow">in</span> <span class="n">fdic</span><span class="p">:</span>
                    <span class="c1"># Only come here if d.mufield = (val1,val2)</span>
                    <span class="c1"># d.mufield[1] = value is resolved as</span>
                    <span class="c1">#    d.__getitem__() returning submap object (e.g. Multiple) followed by</span>
                    <span class="c1">#    submap.__setitem__()</span>
                    <span class="n">occurs</span> <span class="o">=</span> <span class="n">fdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurs&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                        <span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">()</span>
                    <span class="c1"># elif isinstance(occurs, (list,tuple)): # todo</span>
                    <span class="c1">#   get and set occ functions given: set occurrences function</span>
                    <span class="c1">#   to update occurrence count or Format with index range</span>

                    <span class="k">if</span> <span class="n">occurs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">occurs</span><span class="p">):</span>
                            <span class="n">dpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">indx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="Datamap.update"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.Datamap.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">kviter</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update or set the attributes/keys of a datamap to the values</span>
<span class="sd">        in the list given as list or iterable of (key, value) pairs</span>
<span class="sd">        or as list of keyword=value itmes</span>

<span class="sd">        :param kviter: list or iterable of &#39;key&#39;,value pairs</span>
<span class="sd">        :param kw:     list of key=value</span>

<span class="sd">        Example::</span>

<span class="sd">            &gt;&gt; empl.update(name=&#39;Bell&#39;,first_name=&#39;John&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kviter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="fndef2datamap"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.fndef2datamap">[docs]</a><span class="k">def</span> <span class="nf">fndef2datamap</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">fndef</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a Fieldmap class from a fndef list</span>
<span class="sd">    :param fndef: list of fndef tuples</span>
<span class="sd">    :param name: class name to be returned</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Fieldmap</span><span class="p">(</span><span class="n">Datamap</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">Datamap</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">flist</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">Fieldmap</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Fieldmap</span></div>

<span class="c1">#</span>
<span class="c1"># define pack and unpack for numerical types</span>
<span class="c1">#</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Datamap</span><span class="p">(</span> <span class="s1">&#39;formats&#39;</span><span class="p">,</span>
        <span class="n">Unpacked</span><span class="p">(</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Packed</span><span class="p">(</span>   <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Bytes</span><span class="p">(</span>    <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Int1</span><span class="p">(</span>     <span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Int2</span><span class="p">(</span>     <span class="s1">&#39;f2&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Int4</span><span class="p">(</span>     <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Int8</span><span class="p">(</span>     <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Uint1</span><span class="p">(</span>    <span class="s1">&#39;u1&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># unsigned integer</span>
        <span class="n">Uint2</span><span class="p">(</span>    <span class="s1">&#39;u2&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Uint4</span><span class="p">(</span>    <span class="s1">&#39;u4&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">Uint8</span><span class="p">(</span>    <span class="s1">&#39;u8&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">Abuf</span><span class="p">(</span><span class="mi">126</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">setNativeByteOrder</span><span class="p">()</span>

<div class="viewcode-block" id="fpack"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.fpack">[docs]</a><span class="k">def</span> <span class="nf">fpack</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ebcdic</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pack number to byte string in one of the following</span>
<span class="sd">    number representations/formats supported by Adabas:</span>

<span class="sd">        Unpacked, Packed, Binary, Fixpoint, unsigned integer &#39;u&#39;</span>

<span class="sd">    :param value:  number (int/long)</span>
<span class="sd">    :param format: &#39;U&#39;, &#39;P&#39;, &#39;B&#39;, and &#39;F&#39;</span>
<span class="sd">    :param length: allowed are for U:1-30, P:1-15, B:1-126, F:1,2,4,8</span>

<span class="sd">    :returns: string in PY2 and bytes in PY3</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; from adapya.base.datamap import fpack</span>
<span class="sd">        &gt;&gt;&gt; fpack(234,&#39;P&#39;,2) == b&#39;\x23\x4c&#39;</span>
<span class="sd">        True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span><span class="o">.</span><span class="n">setEbcdic</span><span class="p">(</span><span class="n">ebcdic</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">byteorder</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setByteOrder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setNativeByteOrder</span><span class="p">()</span> <span class="c1"># reset</span>
    <span class="k">if</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>   <span class="c1"># set length for converting U with u mapped to buffer</span>
        <span class="n">d</span><span class="o">.</span><span class="n">u</span><span class="o">=</span><span class="n">value</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;P&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">p</span><span class="o">=</span><span class="n">value</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">b</span><span class="o">=</span><span class="n">value</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;F&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">f2</span><span class="o">=</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">f4</span><span class="o">=</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># length == 8</span>
            <span class="n">d</span><span class="o">.</span><span class="n">f8</span><span class="o">=</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span></div>

<div class="viewcode-block" id="funpack"><a class="viewcode-back" href="../../../modules.html#adapya.base.datamap.funpack">[docs]</a><span class="k">def</span> <span class="nf">funpack</span><span class="p">(</span><span class="n">bstring</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ebcdic</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unpacks number from byte string in one of the following</span>
<span class="sd">    number representations/formats supported by Adabas:</span>

<span class="sd">        Unpacked, Packed, Binary, Fixpoint</span>

<span class="sd">    :param value: Byte string</span>
<span class="sd">    :param format: &#39;U&#39;, &#39;P&#39;, &#39;B&#39;, and &#39;F&#39; plus &#39;u&#39; unsigned</span>
<span class="sd">    :param byteorder: NETWORKBO or NATIVEBO (defined in datamap)</span>
<span class="sd">    :returns: number (int/long)</span>

<span class="sd">    Example::</span>

<span class="sd">        &gt;&gt;&gt; from adapya.base.datamap import fpack</span>
<span class="sd">        &gt;&gt;&gt; funpack(b&#39;\x23\x4d&#39;,&#39;P&#39;)</span>
<span class="sd">        -234</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span><span class="o">.</span><span class="n">setEbcdic</span><span class="p">(</span><span class="n">ebcdic</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">byteorder</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setByteOrder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setNativeByteOrder</span><span class="p">()</span> <span class="c1"># reset</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bstring</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="n">bstring</span>
    <span class="k">if</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>   <span class="c1"># set length for converting U with u mapped to buffer</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">u</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;P&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">p</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">setfsize</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">b</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;F&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">f1</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">f2</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">f4</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># length == 8</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">f8</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">&#39;u&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">u1</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">u2</span>
        <span class="k">elif</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">u4</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># length == 8</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">u8</span></div>

<span class="c1">#  Copyright 2004-ThisYear Software AG</span>
<span class="c1">#</span>
<span class="c1">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#  you may not use this file except in compliance with the License.</span>
<span class="c1">#  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#  Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#  See the License for the specific language governing permissions and</span>
<span class="c1">#  limitations under the License.</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2004-2019, software AG

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>